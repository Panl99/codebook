# RabbitMQ概述

## 消息队列

消息队列传递消息一般有两种方式：

1. 点对点模式（P2P）：基于队列，生产者发送消息到队列，消费者从队列接收消息。一对一关系。
2. 发布/订阅模式（Pub/Sub）：发布者发布消息到主题（topic），消息订阅者从主题订阅消息。一对多关系。

消息中间件的作用：

1. **解耦**，应用程序之间不直接通信，而是基于存储和转发的应用程序之间的异步数据发送。可以使开发人员无需了解RPC 和网络通信协议的细节。
2. **存储**，面对数据处理失败，可以将数据持久化到最终处理成功。规避数据丢失风险。
3. **扩展性**，消息中间件解耦了应用的处理过程，只要另外增加处理过程 就可以提高消息入队和处理效率，无需修改代码、调节参数等。
4. **削峰**，可以处理因访问量突增导致的访问压力。
5. **可恢复性**，消息中间件降低进程间的耦合度，即使有处理消息的进程挂掉，加入的消息也可在系统回复后进行处理。
6. **顺序保证**，支持消息处理的顺序。
7. **缓冲**，可通过缓冲层控制消息处理的速度。
8. **异步通信**，消息中间件的异步处理机制，可以控制消息的处理时间。

## RabbitMQ简介

RabbitMQ是采用Erlang语言实现[AMQP](#AMQP)的消息中间件。

起源于金融系统，用于在分布式系统中存储转发消息。

## RabbitMQ特点

1. **高可靠**：使用持久化、传输确认、发布确认...等机制来保证可靠性。

2. **易扩展**：多个RabbitMQ可组成一个集群，可动态扩展集群中的节点。

3. **高可用**：队列可以在集群中的机器上设置镜像，使得在部分节点出现问题的情况下队列仍然可用。
4. **路由灵活**：在消息进入队列之前，通过交换器来路由消息。
   - 对于典型的路由功能，RabbitMQ 己经提供了一些内置的交换器来实现。
   - 针对更复杂的路由功能，可以将多个交换器绑定在一起， 也可以通过插件机制来实现自己的交换器。
5. **多协议支持**：原生支持AMQP 协议，还支持STOMP , MQTT 等多种消息中间件协议。
6. **功能特性丰富**：
   - 支持多种语言：Java、Python、PHP...等
   - 提供管理界面：可以监控、管理消息和集群中的节点等
   - 丰富的插件：提供许多插件来扩展RabbitMQ功能，支持自定义插件。



## RabbitMQ基本概念

1. server：又称broker，接收客户端连接，实现AMQP实体服务。
2. connection：和具体broker网络连接。
3. channel：网络通道，基本上所有操作都在channel中进行，channel是消息读写的通道，每个channel表示一个会话任务，客户端可以建立多个channel。
4. message：消息，服务器和应用之间传递的数据。
   - 由properties和body组成。
   - properties可以对消息进行修饰，比如：消息的优先级，延迟等特性。
   - body是消息的实体内容。
5. Virtual host：虚拟主机，用于逻辑隔离，最上层消息的路由。一个Virtual host可以包含多个Exchange和Queue，同一个Virtual host下Exchange和Queue名字唯一。
6. **Exchange**：交换机，生产者发送消息到交换机，交换机根据路由键转发消息到绑定的队列。
   - fanout：把所有消息路由到绑定的队列中。
   - direct：把消息路由到绑定键跟路由键相同的队列中。（完全匹配）
   - topic：把消息路由到绑定键跟路由键匹配的队列中。（模糊匹配）
     - 路由键和绑定键使用点号`.`分隔字符串。
     - 绑定键中，`*`匹配一个单词；`#`匹配多个单词。
   - headers：根据发送消息内容中的headers属性匹配路由。（性能差，不实用）
7. **Banding**：绑定，将交换机和队列关联起来，绑定时指定一个绑定键BindingKey，绑定键跟路由键匹配时消息会被路由到队列。（通常情况下，绑定键就是路由键）
8. **RoutingKey**：路由键，生产者将消息发送给交换机时指定，指定消息的路由规则，虚拟机根据它来确定如何路由一条消息。
9. **Queue**：消息队列，用于存储消息。



## 死信队列

[https://www.jianshu.com/p/986ee5eb78bc](https://www.jianshu.com/p/986ee5eb78bc)

- 死信队列：DLX（`dead-letter-exchange`）

- 利用DLX，当消息在一个队列中变成死信 `(dead message)` 之后，它能被重新publish到另一个Exchange，这个Exchange就是DLX

**消息变成死信的情况**：

- 消息被拒绝(basic.reject / basic.nack)，并且requeue = false
- 消息TTL过期
- 队列达到最大长度



## AMQP

Advanced Message Queuing Protocol ，高级消息队列协议

# RabbitMQ使用

## RabbitMQ安装





## RabbitMQ实战





# RabbitMQ原理

## RabbitMQ源码分析





## RabbitMQ模块原理



# RabbitMQ优化

## RabbitMQ参数优化



## RabbitMQ二次开发

