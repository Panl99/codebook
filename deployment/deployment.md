
# 蓝绿部署

同时运行两个版本的应用，蓝绿部署时，不停止老版本应用，而是直接再部署一套新版本，等新版本运行起来后，再把流量切到新版本。

但是，这就要求有两套环境支持，硬件要求是平时的两倍。




# 滚动升级

在升级过程中，不一次性更新所有节点，每次更新一个或者一批。

滚动发布可以解决蓝绿部署所需要的两倍环境的要求。

但是，在更新部分节点后，存在新老服务共存的局面，流量进来分发给新老服务的处理结果可能不同。 这就需要对滚动升级进行流量控制。





# 灰度发布(金丝雀发布)

灰度发布时，先启动一个新版本应用，但不将流量直接切过来，而是测试在这个新版本上进行测试，如果没有问题，再将少量的流量切过来，观察新版本运行是否平稳（收集运行时数据，并对比老版本，即[AB测试](#AB测试)），
确认新版本少量流量运行没问题后，再逐步将更多流量切进来，直到100%流量都切到新版本上，之后再关闭剩下的老版本服务，完成灰度发布。

如果在灰度过程中发现有问题，就将流量全部切回老版本，这样最小范围降低影响。

灰度的作用：
1. 发布新版时，避免新版问题，降低影响。
2. 新版本的新特性，可以评估不同版本客户的反馈结果。

## 灰度策略

- 系统级、接口级的灰度：可以在网关/代理Nginx层，由运维负责。
- 灰度规则：后端负责，按用户、城市、渠道、产品等业务相关处理。

## 灰度前提
1. 需要一个放量配置，给产品/运营等工作人员配置放量策略；
2. 需要做到同一个用户始终访问的是同一个版本的代码。


## 灰度场景

### 基于客户端请求的流量切分场景

- 将请求头中带有:`city=sz`的客户端请求转发到灰度环境.
- 或者将Cookie中带有:`city=sz`的客户端请求转发到灰度环境.


### 基于服务权重的流量切分场景

- 将20%的流量切换到灰度环境.


## 灰度方案

1. 配置中心
   
配置项`key=xxx_feature_gray_conf`,内容如下:
```json
[
  {
    "layer": { // 实验层次
      "id": "layer1", // 层标识
      "data": "something1" // 扩展数据(非必须)
    },
    "grayRules": [ // 灰度规则,多条为且的关系
      {
        "name": "source", // 规则名
        "enabled": true, // 是否启用该规则
        "include": [ // 白名单
          "2",
          "21"
        ],
        "exclude": [], // 黑名单
        "global": false // 全量标识
      },
      {
        "name": "city",
        "enabled": true,
        "include": [
          "1",
          "5"
        ],
        "exclude": [],
        "global": false
      }
    ],
    "divRule": { // 分流规则
      "percent": 50 // 分流比例
    }
  },
  {
    "layer": {
      "id": "layer2",
      "data": "something2"
    },
    "grayRules": [
      {
        "name": "source",
        "enabled": true,
        "include": [
          "1"
        ],
        "exclude": [],
        "global": false
      },
      {
        "name": "city",
        "enabled": true,
        "include": [
          "3"
        ],
        "exclude": [],
        "global": false
      }
    ],
    "divRule": {
      "percent": 100
    }
  }
]
```



### SimpleGray

1. 对于web端,可以通过请求端口区分,再开一个灰度端口,使用灰度端口的请求Nginx转到灰度环境.
2. 对于设备端,设备动态注册,激活,连接 过程中,可以先预置灰度设备到Redis缓存中,设备激活时判断是否预置的灰度设备来决定是否返回灰度环境连接地址.
3. 对于三方调用:
    - 动态api(平台返回的动态地址给第三方):平台可以根据是否灰度设备 返回灰度的回调地址给第三方,Nginx端配置灰度地址转灰度环境.
    - 静态api(固定的三方访问地址):需要预加载灰度数据源到Nginx缓存,三方的请求头设置设备信息,Nginx比较header的设备信息是否存在灰度缓存中 判断请求是否需要转到灰度环境.

[Nginx加载数据源:Nginx + lua + redis](https://juejin.cn/post/7313446602440933414)


# AB测试

让一部分用户使用老版本A，一部分使用新版本B，如果用户使用B版本没问题的话，那就逐步扩大范围，将所有用户切到B版本上来。