> [ShardingSphere-JDBC 入门教程](https://juejin.cn/post/6956387543482892295)


Apache ShardingSphere 是一款分布式的数据库生态系统， 可以将任意数据库转换为分布式数据库，并通过数据分片、弹性伸缩、加密等能力对原有数据库进行增强。

ShardingSphere-JDBC 是 Apache ShardingSphere 中的子模块，定位为轻量级 Java 框架，在 Java 的 JDBC 层提供的额外服务。 它使用客户端直连数据库，以 jar 包形式提供服务，无需额外部署和依赖，可理解为增强版的 JDBC 驱动，完全兼容 JDBC 和各种 ORM 框架。

ShardingSphere-JDBC 的核心功能为数据分片和读写分离。通过ShardingSphere-JDBC，应用可以透明的使用 JDBC 访问已经分库分表、读写分离的多个数据源，而不用关心数据源的数量以及数据如何分布。


> [demo-mysql-shardingsphere](https://github.com/Panl99/demo/tree/master/demo-mysql-shardingsphere)
 

# 分库分表

## 分库

用户过多，数据量、请求量过大，就需要分库。
一般，单库最多支撑并发量 2000 QPS（最好在1000左右）。

分库数量：

## 分表

当一张表数据达千万及以上，同时日增长在2%以上。（主要是对这张表的写入和查询影响到正常业务的执行时）

分表数量（2<sup>n</sup>）：64、128、256，具体多少根据情况，至少保证几年内数据量的增长不会过大（超千万级），尽可能在数据库可接受范围内增大分表数，毕竟要是达到瓶颈再次分表是非常麻烦的。

## 水平拆分

把一个表的数据分到多个库多个表中

数据存放均匀，多个库可以抗住更高的并发，多个库的存储容量扩容。

## 垂直拆分

把一个有多个字段的表拆成多个表 或者库

每个库表结构不一样，包含部分字段，可以将高频字段 和低频字段分开存放。


## 水平分库分表优缺点

优点：
1. 不存在单库数据量过大、高并发的性能瓶颈，提升系统稳定性和负载能力；
2. 应用端改造较小，不需要拆分业务模块。

缺点：
1. 跨分片的事务一致性难以保证；（使用分布式事务seata）
2. 跨库的join关联查询性能较差；（基本要告别join跨库关联查询这种方式，另外粗略的解决方法：全局的基础数据所有库都拷一份、加入冗余字段、分别查出后在业务代码里组装、把关系密切的表放在一个节点上）
3. 数据多次扩展难度和维护量极大。（Range策略只需要加表就好了，Hash策略比较麻烦，建议一开始就尽量按大了分）


# 线上系统如何平滑切换？

## 方案1：停机迁移

利弊：
1. 几个小时的停机，如0-6点
2. 凌晨3点搞不定有点慌，凌晨5点搞不定马上回滚，改天接着搞
3. 连续通宵吃不消

流程：
1. 提前发公告，后天凌晨0-6点系统维护，不能访问
2. 提前写好数据导入工具
3. 到点停机，拒绝访问
4. 开始操作，修改配置，将数据导入数据库中间件，后台临时部署几台机器，每台机器开20个线程，1小时内完成数据迁移
5. 修改系统数据库连接配置等，以及相关的代码修改，用最新的配置、代码去连接到分库分表上
6. 对系统进行测试

## 方案2：双写迁移

利弊：
1. 不用停机
2. 操作麻烦

流程：
1. 修改写库代码，同时写老库和新的分库分表库，查数据还从老库查
2. 提前写好数据导入工具，部署同步写系统，读取老库数据写入新库，写时要判断update_time字段判断数据老旧，新库没有就新增，新库有要判断时间前后是否覆盖
3. 导完一轮后做数据检查，检查新老库数据是否一致
4. 对不一致的数据继续进行第2步的同步，直到新库老库数据完全一致
5. 基于只使用分库分表代码重新部署服务
6. 观察系统运行情况